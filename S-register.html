<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SchedulED - Register</title>
<link rel="stylesheet" href="S-register.css">

<!-- Firebase App -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<!-- Firebase Realtime Database -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="register-container">
  <h1>SchedulED</h1>
  <p>Student Registration</p>

  <form id="registerForm">
    <input type="text" class="input-box" id="fullName" placeholder="Full Name" required>
    <input type="text" class="input-box" id="uidNumber" placeholder="UID Number" required>
    <input type="email" class="input-box" id="email" placeholder="Email" required>

    <select class="input-box2" id="year" required>
      <option value="" disabled selected>Select Year</option>
      <option value="FE">FE</option>
      <option value="SE">SE</option>
      <option value="TE">TE</option>
      <option value="BE">BE</option>
    </select>

    <input type="text" class="input-box" id="division" placeholder="Division" required>
    <input type="tel" class="input-box" id="phone" placeholder="Phone Number" required>
    <input type="password" class="input-box" id="password" placeholder="Password" required>

    <button type="submit" class="login-btn">Register</button>
  </form>

  <div class="register-text">
    Already have an account? <a href="index.html">Login</a>
  </div>
</div>

<script>
  // 1️⃣ Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyA__THZvmy-KunEeRoDjrkmHVqX2rMHkQQ",
    authDomain: "teacher-slot-booking.firebaseapp.com",
    databaseURL: "https://teacher-slot-booking-default-rtdb.firebaseio.com",
    projectId: "teacher-slot-booking",
    storageBucket: "teacher-slot-booking.firebasestorage.app",
    messagingSenderId: "170703292135",
    appId: "1:170703292135:web:f79de901ed5d3de54d4442",
    measurementId: "G-ET3TE5ZCQS"
  };

  // 2️⃣ Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // 3️⃣ Sync old students from localStorage to Firebase (only once)
  function syncOldStudents() {
    const oldStudents = JSON.parse(localStorage.getItem("students")) || [];
    oldStudents.forEach(student => {
      const key = student.email.replace('.', '_'); 
      db.ref('students/' + key).once('value', snapshot => {
        if (!snapshot.exists()) {
          db.ref('students/' + key).set(student)
            .then(() => console.log(`Old student synced: ${student.email}`))
            .catch(err => console.error(err));
        }
      });
    });
  }

  syncOldStudents();

  // 4️⃣ Handle new student registration
  document.getElementById("registerForm").addEventListener("submit", function(event) {
    event.preventDefault();

    const fullName = document.getElementById("fullName").value.trim();
    const uidNumber = document.getElementById("uidNumber").value.trim();
    const email = document.getElementById("email").value.trim();
    const year = document.getElementById("year").value;
    const division = document.getElementById("division").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const password = document.getElementById("password").value;

    let students = JSON.parse(localStorage.getItem("students")) || [];

    const exists = students.some(s => s.uidNumber === uidNumber || s.email === email);
    if (exists) {
      alert("UID or Email already registered.");
      return;
    }

    const student = { fullName, uidNumber, email, year, division, phone, password };

    // Save in localStorage
    students.push(student);
    localStorage.setItem("students", JSON.stringify(students));

    // Save in Firebase
   const key = email.replace(/[.#$/\[\]@]/g, "_");
    db.ref('students/' + key).set(student)
      .then(() => {
        alert("Registration successful! Saved in Firebase and localStorage.");
        window.location.href = "index.html";
      })
      .catch(err => {
        console.error("Firebase error:", err);
        alert("Failed to save in Firebase. Check console.");
      });
  });
</script>
</body>
</html>

